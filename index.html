<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>APUNTADO PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
/* Estilos Base Mantenidos */
*{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body{margin:0;background:#000;color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
h1{text-align:center;letter-spacing:4px;margin:15px 0;font-size:24px;color:#fff;}

.top-controls{
  display:flex;justify-content:center;gap:15px;
  margin-bottom:15px;padding:0 10px;
}

select, button{
  background:#111;color:#fff;border:1px solid #333;
  border-radius:8px;padding:12px;font-size:14px;transition: 0.2s;
}

button:active{transform: scale(0.95);}
button:disabled{opacity:0.2; transform: none;}

.btn-undo{border-color:#d4af37;color:#d4af37}

/* REJILLA DE JUGADORES (Móvil: 2 columnas, PC: auto-ajuste) */
.players{
  display:grid;
  grid-template-columns: 1fr 1fr; 
  gap:10px;padding:0 10px 20px 10px;flex:1;
  align-content: start;
}

@media (min-width: 768px) {
  .players {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    max-width: 1200px;
    margin: 0 auto;
  }
}

.player{
  border:1px solid #222;padding:15px 5px;
  display:flex;flex-direction:column;border-radius:12px;
  background: #050505; position: relative;
  height: 200px;
}

.player.disabled{opacity:0.25; filter: grayscale(1);}
.player.winner{border:2px solid #d4af37; box-shadow: 0 0 15px rgba(212,175,55,0.3);}
.player.winner .name{color: #d4af37; font-weight: 900;}

.name-block{display:flex;flex-direction:column;align-items:center;min-height: 50px;}

.name{
  text-align:center;font-size:16px;font-weight:bold;
  background:transparent;border:none;color:#fff;
  outline:none;text-transform:uppercase;width:100%;
}

.entradas{
  margin-top:4px;background:#ffeb3b;color:#000;
  font-size:11px;padding:2px 8px;border-radius:4px;
  font-weight: bold;
}

.divider{height:1px;background:#222;margin:10px 15% }

.score-zone{
  flex:1;display:flex;flex-direction:column;
  justify-content:center;align-items:center;cursor:pointer;
}

.score{font-size: 50px; font-weight:bold; transition: 0.3s;}
.score.out{color:#e55353}

.winner-label{
  margin-top:5px;color:#d4af37;font-size: 12px;
  font-weight:bold;letter-spacing:2px;
}

/* Modales */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,0.9);
  display:none;align-items:center;justify-content:center;z-index:100;
}

.modal-box{
  background:#111;padding:25px;border-radius:15px;
  text-align:center;width:85%;max-width:320px;border: 1px solid #333;
}

#modalText{margin-bottom: 15px; font-size: 18px; line-height: 1.4;}

.modal-box input{
  width:100%;padding:15px;font-size:24px;
  text-align:center;background:#000;color:#fff;
  border:1px solid #444;margin-bottom:20px; border-radius: 10px;
}

.modal-actions{display:flex;gap:10px}
.modal-actions button{flex:1; padding: 15px; font-weight: bold;}

.btn-yes{background:#1b4332; color:#95d5b2; border-color:#2d6a4f}
.btn-no{background:#431b1b; color:#e5a0a0; border-color:#6b2f2f}
</style>
</head>

<body>

<h1>APUNTADO</h1>

<div class="top-controls">
  <select id="count">
    <option value="0">INICIO</option>
    <option value="2">2 JUGADORES</option>
    <option value="3">3 JUGADORES</option>
    <option value="4">4 JUGADORES</option>
    <option value="5">5 JUGADORES</option>
    <option value="6">6 JUGADORES</option>
  </select>
  <button class="btn-undo" id="undo" onclick="undo()" disabled>DESHACER</button>
</div>

<div class="players" id="players"></div>

<div class="modal" id="modal">
  <div class="modal-box">
    <div id="modalText"></div>
    <input id="modalInput" type="number" inputmode="numeric" pattern="[0-9]*">
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<script>
let state = JSON.parse(localStorage.getItem("apuntado_v2")) || {
  players: [],
  history: [],
  winner: null
};

const playersDiv = document.getElementById("players");
const countSel = document.getElementById("count");
const undoBtn = document.getElementById("undo");
const modal = document.getElementById("modal");
const modalText = document.getElementById("modalText");
const modalInput = document.getElementById("modalInput");
const modalActions = document.getElementById("modalActions");

function save() {
  localStorage.setItem("apuntado_v2", JSON.stringify(state));
  undoBtn.disabled = state.history.length === 0;
}

function snapshot() {
  const dataClone = JSON.stringify({
    players: state.players,
    winner: state.winner
  });
  state.history.push(dataClone);
  if(state.history.length > 20) state.history.shift();
}

function showModal(text, showInput, actionsHtml) {
  modalText.textContent = text;
  modalInput.value = "";
  modalInput.style.display = showInput ? "block" : "none";
  modalActions.innerHTML = actionsHtml;
  modal.style.display = "flex";
  if(showInput) setTimeout(() => modalInput.focus(), 100);
}

function closeModal() {
  modal.style.display = "none";
}

function render() {
  playersDiv.innerHTML = "";
  if (state.players.length === 0) return;

  state.players.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = `player ${p.disabled ? 'disabled' : ''} ${state.winner === i ? 'winner' : ''}`;
    
    card.innerHTML = `
      <div class="name-block">
        <input class="name" value="${p.name}" ${state.winner !== null ? 'disabled' : ''}>
        ${p.entradas > 0 ? `<div class="entradas">ENTRADAS: ${p.entradas}</div>` : ""}
      </div>
      <div class="divider"></div>
      <div class="score-zone">
        <div class="score ${p.score >= 101 ? 'out' : ''}">${p.score}</div>
        ${state.winner === i ? '<div class="winner-label">GANADOR</div>' : ""}
      </div>
    `;

    const nInput = card.querySelector(".name");
    nInput.onchange = (e) => { 
      p.name = e.target.value.toUpperCase(); 
      save(); 
    };
    nInput.onfocus = () => nInput.select();

    card.querySelector(".score-zone").onclick = () => {
      if(state.winner === null && !p.disabled) openScoreModal(i);
    };

    playersDiv.appendChild(card);
  });
  undoBtn.disabled = state.history.length === 0;
}

function openScoreModal(i) {
  showModal(`Puntos para ${state.players[i].name}`, true, `
    <button onclick="applyScore(${i}, 1)">SUMAR</button>
    <button onclick="applyScore(${i}, -1)" style="border-color:#6b2f2f">RESTAR</button>
  `);
}

function applyScore(i, multiplier) {
  const val = parseInt(modalInput.value);
  if (isNaN(val)) return;
  snapshot();
  state.players[i].score += (val * multiplier);
  closeModal();
  checkGameLogic();
}

function checkGameLogic() {
  const luckyWinner = state.players.findIndex(p => !p.disabled && p.score <= -51);
  if (luckyWinner !== -1) {
    state.winner = luckyWinner;
    save(); render(); return;
  }

  const pendingReentry = state.players.findIndex(p => !p.disabled && p.score >= 101);
  if (pendingReentry !== -1) {
    askReentry(pendingReentry);
    return;
  }

  const actives = state.players.filter(p => !p.disabled);
  if (actives.length === 1 && state.players.length > 0) {
    state.winner = state.players.findIndex(p => !p.disabled);
  }

  save();
  render();
}

function askReentry(i) {
  showModal(`${state.players[i].name} ¿Desea reingresar?`, false, `
    <button class="btn-yes" onclick="prepareReentry(${i})">SÍ</button>
    <button class="btn-no" onclick="eliminatePlayer(${i})">NO</button>
  `);
}

function prepareReentry(i) {
  showModal("¿Con cuántos puntos entra?", true, `
    <button class="btn-yes" onclick="executeReentry(${i})">ENTRAR</button>
  `);
}

function executeReentry(i) {
  const val = parseInt(modalInput.value);
  if (isNaN(val)) return;
  state.players[i].score = val;
  state.players[i].entradas++;
  closeModal();
  checkGameLogic();
}

function eliminatePlayer(i) {
  state.players[i].disabled = true;
  closeModal();
  checkGameLogic();
}

// Botón Deshacer con Confirmación
function undo() {
  if (state.history.length === 0) return;
  
  if (confirm("¿Deseas deshacer la última acción?")) {
    const lastState = JSON.parse(state.history.pop());
    state.players = lastState.players;
    state.winner = lastState.winner;
    save();
    render();
  }
}

countSel.onchange = () => {
  const num = parseInt(countSel.value);
  if (state.players.length > 0) {
    if (!confirm("¿Seguro que quieres cambiar la partida? Esto borrará el progreso actual.")) {
      countSel.value = state.players.length || "0";
      return;
    }
  }

  if (num === 0) {
    state = { players: [], history: [], winner: null };
    localStorage.removeItem("apuntado_v2");
  } else {
    state.players = Array.from({length: num}, (_, i) => ({
      name: `NOMBRE ${i + 1}`,
      score: 0,
      entradas: 0,
      disabled: false
    }));
    state.winner = null;
    state.history = [];
  }
  save();
  render();
};

if(state.players.length > 0) {
    countSel.value = state.players.length;
} else {
    countSel.value = "0";
}
render();
</script>
</body>
</html>
