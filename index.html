<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>APUNTADO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  background: #000;
  color: #fff;
  min-height: 100vh;
}

header {
  text-align: center;
  padding: 15px;
}

h1 {
  margin: 5px 0;
  letter-spacing: 4px;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

select, button {
  padding: 8px 12px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #000;
  color: #fff;
}

button {
  cursor: pointer;
}

button.active, .btn-play.active {
  background-color: #2f6b3f;
  color: #fff;
  border-color: #2f6b3f;
}

.btn-play {
  border-color: #2f6b3f;
  color: #9be5b1;
}

.btn-danger {
  border-color: #6b2f2f;
  color: #e5a0a0;
}

.players {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(3, 1fr);
  height: calc(100vh - 190px);
}

.player {
  border: 1px solid #222;
  padding: 10px;
  display: flex;
  flex-direction: column;
  transition: opacity 0.3s, border 0.3s;
  position: relative;
}

.player.disabled {
  opacity: 0.4;
  pointer-events: none;
}

.player.winner {
  border: 2px solid #d4af37;
}

.player.winner input {
  font-weight: bold;
}

.name-zone input {
  width: 100%;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 18px;
  text-align: center;
  outline: none;
}

.entry-count {
  text-align: center;
  color: #ffea00;
  font-weight: bold;
  margin-top: 6px;
  font-size: 14px;
}

.divider {
  height: 1px;
  background: #333;
  margin: 8px 0;
}

.score-zone {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.score {
  font-size: 48px;
  font-weight: bold;
  transition: color 0.3s;
}

.score.out {
  color: #e05252;
}

.winner-label {
  margin-top: 6px;
  font-size: 14px;
  letter-spacing: 2px;
  color: #d4af37;
}

.bottom-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 10px;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #111;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  width: 85%;
  max-width: 320px;
}

.modal-content input {
  width: 100%;
  padding: 12px;
  font-size: 22px;
  margin-bottom: 12px;
  text-align: center;
  background: #000;
  color: #fff;
  border: 1px solid #333;
}

.modal-buttons {
  display: flex;
  gap: 10px;
}

.modal-buttons button {
  flex: 1;
}

.overlay-question {
  position: fixed;
  inset: 0;
  background: transparent;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1050;
}

.overlay-content {
  border: 3px solid orange;
  background: #111;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  width: 90%;
  max-width: 320px;
}

.overlay-buttons {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 20px;
}

.overlay-buttons button {
  padding: 10px 25px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 16px;
}

.overlay-buttons .btn-yes {
  background-color: #2f6b3f;
  color: white;
}

.overlay-buttons .btn-no {
  background-color: #e05252;
  color: white;
}
</style>
</head>

<body>

<header>
  <h1>APUNTADO</h1>
  <div class="controls">
    <select id="playerCount"></select>
    <button id="btnRules">Reglas</button>
    <button class="btn-play" id="btnPlay" disabled>JUGAR</button>
  </div>
</header>

<div class="players" id="players"></div>

<div class="bottom-controls">
  <button class="btn-danger" id="btnUndo">DESHACER</button>
  <button class="btn-danger" id="btnReset">REINICIAR</button>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <input id="pointsInput" type="number" inputmode="numeric" placeholder="Puntos" />
    <div class="modal-buttons">
      <button id="btnSumar">+ Sumar</button>
      <button id="btnRestar">− Restar</button>
    </div>
  </div>
</div>

<div class="overlay-question" id="overlayQuestion">
  <div class="overlay-content">
    <div id="overlayText" style="font-size: 18px; font-weight: bold; color: orange; margin-bottom: 12px;"></div>
    <div class="overlay-buttons">
      <button class="btn-yes" id="btnYes">SI</button>
      <button class="btn-no" id="btnNo">NO</button>
    </div>
  </div>
</div>

<script>
const playersContainer = document.getElementById("players");
const selector = document.getElementById("playerCount");
const modal = document.getElementById("modal");
const pointsInput = document.getElementById("pointsInput");
const overlayQuestion = document.getElementById("overlayQuestion");
const overlayText = document.getElementById("overlayText");
const btnRules = document.getElementById("btnRules");
const btnPlay = document.getElementById("btnPlay");
const btnUndo = document.getElementById("btnUndo");
const btnReset = document.getElementById("btnReset");
const btnYes = document.getElementById("btnYes");
const btnNo = document.getElementById("btnNo");
const btnSumar = document.getElementById("btnSumar");
const btnRestar = document.getElementById("btnRestar");

let currentScoreElement = null;
let currentPlayerIndex = null;
let awaitingEntryDecisionIndex = null;
let awaitingEntryModal = false;
let history = [];
let gameOver = false;
let winnerIndex = null;
let namesEdited = false;

function initPlayerCountOptions() {
  selector.innerHTML = "";
  for(let i = 2; i <= 6; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i} jugadores`;
    selector.appendChild(option);
  }
}
initPlayerCountOptions();

function saveGame() {
  const players = [];
  document.querySelectorAll(".player").forEach(p => {
    players.push({
      name: p.querySelector(".name-zone input").value,
      score: parseInt(p.querySelector(".score").textContent),
      out: p.classList.contains("disabled"),
      entries: parseInt(p.getAttribute("data-entries")) || 0
    });
  });
  localStorage.setItem("apuntadoGame", JSON.stringify({
    count: selector.value,
    players
  }));
  updatePlayButtonState(false);
  namesEdited = false;
}

function loadGame() {
  const saved = localStorage.getItem("apuntadoGame");
  if (!saved) return null;
  try {
    return JSON.parse(saved);
  } catch {
    return null;
  }
}

function saveSnapshot() {
  const snapshot = localStorage.getItem("apuntadoGame");
  if (snapshot) history.push(snapshot);
  if (history.length > 50) history.shift();
}

function renderPlayers() {
  playersContainer.innerHTML = "";
  const savedData = loadGame();

  if(savedData) {
    selector.value = savedData.count;
  }

  const count = parseInt(selector.value);

  for(let i = 0; i < count; i++) {
    const player = document.createElement("div");
    player.className = "player";

    const playerData = savedData?.players?.[i];
    const name = playerData?.name || `Jugador ${i + 1}`;
    const score = playerData?.score ?? 0;
    const out = playerData?.out || false;
    const entries = playerData?.entries || 0;

    if(out) player.classList.add("disabled");
    if(gameOver) {
      if(i === winnerIndex) {
        player.classList.add("winner");
      } else {
        player.classList.add("disabled");
      }
    }

    player.setAttribute("data-entries", entries);

    player.innerHTML = `
      <div class="name-zone">
        <input value="${name}" ${gameOver ? "disabled" : ""} />
        <div class="entry-count">${entries > 0 ? `ENTRADAS: ${entries}` : ""}</div>
      </div>
      <div class="divider"></div>
      <div class="score-zone">
        <div class="score ${out ? "out" : ""}">${score}</div>
        ${gameOver && i === winnerIndex ? `<div class="winner-label">GANADOR (${score})</div>` : ""}
      </div>
    `;

    if(!gameOver && !out) {
      player.querySelector(".score-zone").onclick = () => {
        currentScoreElement = player.querySelector(".score");
        currentPlayerIndex = i;
        pointsInput.value = "";
        modal.style.display = "flex";
        pointsInput.focus();
      };
    }

    playersContainer.appendChild(player);
  }
  saveGame();
}

function closeModal() {
  modal.style.display = "none";
  pointsInput.value = "";
  awaitingEntryModal = false;
}

function applyPoints(multiplier) {
  const value = parseInt(pointsInput.value);
  if(isNaN(value)) return;

  if(awaitingEntryModal && awaitingEntryDecisionIndex !== null) {
    if(value < 0 || value > 100) {
      alert("Ingrese un puntaje entre 0 y 100");
      return;
    }
    saveSnapshot();
    const savedData = loadGame();
    if(savedData) {
      savedData.players[awaitingEntryDecisionIndex].score = value;
      savedData.players[awaitingEntryDecisionIndex].out = false;
      savedData.players[awaitingEntryDecisionIndex].entries = (savedData.players[awaitingEntryDecisionIndex].entries || 0) + 1;
      localStorage.setItem("apuntadoGame", JSON.stringify(savedData));
      awaitingEntryDecisionIndex = null;
      awaitingEntryModal = false;
      overlayQuestion.style.display = "none";
      closeModal();
      checkOutPlayers();
      renderPlayers();
    }
    return;
  }

  saveSnapshot();

  let currentScore = parseInt(currentScoreElement.textContent);
  currentScore += value * multiplier;
  currentScoreElement.textContent = currentScore;

  checkWinner();
  checkOutPlayers();

  closeModal();
  renderPlayers();
}

function checkWinner() {
  if(gameOver) return;
  const scores = document.querySelectorAll(".score");
  scores.forEach((scoreEl, index) => {
    const value = parseInt(scoreEl.textContent);
    if(value <= -51) {
      gameOver = true;
      winnerIndex = index;
      renderPlayers();
      alert(`¡GANADOR!\n${scoreEl.textContent} puntos`);
    }
  });
}

function checkOutPlayers() {
  if(gameOver) return;
  const savedData = loadGame();
  if(!savedData) return;

  for(let i = 0; i < savedData.players.length; i++) {
    if(savedData.players[i].score >= 101 && !savedData.players[i].out) {
      // Preguntar si quiere entrar nuevamente
      awaitingEntryDecisionIndex = i;
      showOverlayQuestion(`${savedData.players[i].name} superó 101 puntos.\n¿Desea entrar nuevamente?`);
      break;
    }
  }
}

function showOverlayQuestion(text) {
  overlayText.textContent = text;
  overlayQuestion.style.display = "flex";
}

btnYes.onclick = () => {
  overlayQuestion.style.display = "none";
  awaitingEntryModal = true;
  modal.style.display = "flex";
  pointsInput.value = "";
  pointsInput.focus();
};

btnNo.onclick = () => {
  overlayQuestion.style.display = "none";
  if(awaitingEntryDecisionIndex !== null) {
    saveSnapshot();
    const savedData = loadGame();
    if(savedData) {
      savedData.players[awaitingEntryDecisionIndex].out = true;
      localStorage.setItem("apuntadoGame", JSON.stringify(savedData));
      awaitingEntryDecisionIndex = null;
      renderPlayers();
    }
  }
};

btnSumar.onclick = () => applyPoints(1);
btnRestar.onclick = () => applyPoints(-1);

btnUndo.onclick = () => {
  if(history.length === 0) {
    alert("No hay acciones para deshacer");
    return;
  }
  const last = history.pop();
  if(last) {
    localStorage.setItem("apuntadoGame", last);
    gameOver = false;
    winnerIndex = null;
    renderPlayers();
  }
};

btnReset.onclick = () => {
  if(confirm("¿Seguro que quieres reiniciar el juego?")) {
    localStorage.removeItem("apuntadoGame");
    history = [];
    gameOver = false;
    winnerIndex = null;
    renderPlayers();
    updatePlayButtonState(false);
  }
};

selector.onchange = () => {
  if(confirm("Cambiar la cantidad de jugadores reiniciará el juego. ¿Continuar?")) {
    localStorage.removeItem("apuntadoGame");
    history = [];
    gameOver = false;
    winnerIndex = null;
    namesEdited = false;
    renderPlayers();
    updatePlayButtonState(false);
  } else {
    // Revert selection to previous value if canceled
    const savedData = loadGame();
    if(savedData) {
      selector.value = savedData.count;
    } else {
      selector.value = 2;
    }
  }
};

btnRules.onclick = () => {
  alert(
`Cómo jugar APUNTADO (Juego de cartas con dos mazos)

APUNTADO es un juego de cartas que se juega con dos mazos completos. Por eso, en el juego pueden aparecer cartas repetidas.

Esto significa que en las combinaciones de ternas, cuartas, etc., y escaleras, se pueden repetir cartas del mismo valor y pinta.
  • Cada jugador recibe 10 cartas, excepto quien reparte que recibe 11.
  • El objetivo es formar combinaciones con tus cartas llamadas ternas, cuartas, etc., y escaleras.
  • Las escaleras son grupos de 4 o más cartas consecutivas del mismo palo.
  • Puedes usar jokers (comodines) para completar tus combinaciones.
  • Para bajarse, debes poner todas tus cartas en combinaciones (ternas, cuartas, escaleras).
  • Si bajas todas tus cartas, ganas -10 puntos.
  • También puedes “tocar” bajando 8 o 9 cartas en combinaciones, siempre que las cartas que te queden sumen máximo 5 puntos.
  • Las letras J, Q, K y A valen 10 puntos cada una.
  • Si alguien se baja antes que otro se pinte, la persona que quiere pintarse debe combinar todas sus cartas.
  • Las cartas que no logre combinar suman puntos para esa persona.
  • Después que alguien se baja, los demás pueden bajar las combinaciones que ya tengan armadas.

⸻

Sobre pintarse
  • Cuando un jugador tiene todas sus cartas del mismo palo, se dice que se pinta y obtiene -25 puntos.

El fin del juego
  • El juego termina cuando un jugador:
  1. Hace que los demás lleguen a más de 101 puntos (los “saca” del juego), o
  2. Llega a -51 puntos o menos.
  • Quien logre cualquiera de estas dos cosas primero, gana la partida
  `
  );
};

btnPlay.onclick = saveGame;

function updatePlayButtonState(enabled) {
  if(enabled) {
    btnPlay.disabled = false;
    btnPlay.classList.add("active");
  } else {
    btnPlay.disabled = true;
    btnPlay.classList.remove("active");
  }
}

function onNameEdit() {
  if(!namesEdited) {
    namesEdited = true;
    updatePlayButtonState(true);
  }
}

playersContainer.addEventListener("input", e => {
  if(e.target.tagName === "INPUT" && e.target.parentElement.classList.contains("name-zone")) {
    onNameEdit();
  }
});

renderPlayers();
</script>
</body>
</html>