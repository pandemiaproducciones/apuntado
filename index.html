<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>APUNTADO - Versión mínima</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body {
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
  }
  .players {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .player {
    border: 1px solid #555;
    padding: 10px;
    width: 120px;
    text-align: center;
    user-select: none;
  }
  .player input {
    width: 100%;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 16px;
    text-align: center;
  }
  .score {
    font-size: 36px;
    margin: 10px 0;
    cursor: pointer;
  }
  button {
    padding: 6px 12px;
    background: #222;
    color: #fff;
    border: 1px solid #444;
    cursor: pointer;
  }
  #controls {
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<h1>APUNTADO - Mínima</h1>

<div id="controls">
  <label for="playerCount">Cantidad jugadores:</label>
  <select id="playerCount">
    <option value="2">2 jugadores</option>
    <option value="3">3 jugadores</option>
    <option value="4">4 jugadores</option>
  </select>
  <button id="btnSaveGame">Guardar</button>
  <button id="btnUndo">Deshacer</button>
</div>

<div class="players" id="players"></div>

<script>
const playersContainer = document.getElementById("players");
const selector = document.getElementById("playerCount");
const btnSaveGame = document.getElementById("btnSaveGame");
const btnUndo = document.getElementById("btnUndo");

let history = [];
let currentScoreElement = null;

function renderPlayers() {
  playersContainer.innerHTML = "";
  const count = parseInt(selector.value);
  const saved = JSON.parse(localStorage.getItem("apuntadoGame") || "{}");
  const savedPlayers = saved.players || [];

  for (let i = 0; i < count; i++) {
    const playerDiv = document.createElement("div");
    playerDiv.className = "player";

    const name = savedPlayers[i]?.name || `Jugador ${i+1}`;
    const score = savedPlayers[i]?.score ?? 0;

    playerDiv.innerHTML = `
      <input type="text" value="${name}" data-index="${i}" />
      <div class="score" data-index="${i}">${score}</div>
      <button data-index="${i}" class="btnAdd">+1</button>
      <button data-index="${i}" class="btnSub">-1</button>
    `;

    playersContainer.appendChild(playerDiv);
  }

  attachEvents();
}

function attachEvents() {
  document.querySelectorAll(".btnAdd").forEach(btn => {
    btn.onclick = () => changeScore(parseInt(btn.dataset.index), 1);
  });
  document.querySelectorAll(".btnSub").forEach(btn => {
    btn.onclick = () => changeScore(parseInt(btn.dataset.index), -1);
  });
  document.querySelectorAll(".player input").forEach(input => {
    input.onchange = () => {
      saveHistory();
    };
  });
}

function changeScore(index, delta) {
  saveHistory();

  const saved = JSON.parse(localStorage.getItem("apuntadoGame") || "{}");
  const players = saved.players || [];

  // Asegurar que el índice exista
  if (!players[index]) {
    players[index] = { name: `Jugador ${index+1}`, score: 0 };
  }

  players[index].score = (players[index].score || 0) + delta;

  // Guardar y renderizar
  localStorage.setItem("apuntadoGame", JSON.stringify({ count: players.length, players }));
  renderPlayers();
}

function saveGame() {
  const players = [];
  document.querySelectorAll(".player").forEach(p => {
    const name = p.querySelector("input").value.trim() || "Jugador";
    const score = parseInt(p.querySelector(".score").textContent) || 0;
    players.push({ name, score });
  });
  localStorage.setItem("apuntadoGame", JSON.stringify({ count: players.length, players }));
  alert("Juego guardado");
}

function saveHistory() {
  const snapshot = localStorage.getItem("apuntadoGame");
  if (snapshot) {
    history.push(snapshot);
    if (history.length > 20) history.shift(); // Limitar historial para no saturar
  }
}

function undoLast() {
  if (history.length === 0) {
    alert("No hay acciones para deshacer");
    return;
  }
  const last = history.pop();
  localStorage.setItem("apuntadoGame", last);
  renderPlayers();
}

selector.onchange = () => {
  saveHistory();
  renderPlayers();
};

btnSaveGame.onclick = () => saveGame();
btnUndo.onclick = () => undoLast();

renderPlayers();

</script>
</body>
</html>
